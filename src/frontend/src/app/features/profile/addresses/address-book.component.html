<p-toast></p-toast>
<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 md:p-8">

  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 pb-4 border-b border-gray-100 gap-4">
    <h2 class="text-xl font-bold text-gray-900">Sổ địa chỉ</h2>
    <button pButton label="Thêm địa chỉ mới" icon="pi pi-plus" (click)="openDialog()"
      class="bg-pink-600 border-pink-600 hover:bg-pink-700"></button>
  </div>

  <div *ngIf="isLoading" class="text-center py-12">
    <i class="pi pi-spin pi-spinner text-3xl text-pink-600 mb-3"></i>
    <p class="text-gray-500">Đang tải danh sách địa chỉ...</p>
  </div>

  <div *ngIf="!isLoading && addresses.length === 0"
    class="text-center py-12 bg-gray-50 rounded-lg border border-dashed border-gray-200">
    <i class="pi pi-map-marker text-4xl text-gray-300 mb-3"></i>
    <p class="text-gray-500 mb-4">Bạn chưa lưu địa chỉ nào.</p>
    <button pButton label="Thêm ngay" icon="pi pi-plus" (click)="openDialog()"
      class="p-button-outlined p-button-secondary p-button-sm"></button>
  </div>

  <div *ngIf="!isLoading && addresses.length > 0" class="grid grid-cols-1 gap-4">
    <div *ngFor="let addr of addresses"
      class="border rounded-xl p-5 relative hover:border-pink-300 transition-all bg-white"
      [ngClass]="{'border-pink-500 ring-1 ring-pink-100': addr.isDefault, 'border-gray-200': !addr.isDefault}">

      <div *ngIf="addr.isDefault" class="absolute top-4 right-4">
        <p-tag value="Mặc định" severity="danger" [rounded]="true"></p-tag>
      </div>

      <div class="pr-20">
        <div class="flex items-center gap-3 mb-2">
          <span class="font-bold text-gray-900 text-lg">{{ addr.receiverName }}</span>
          <span class="text-gray-300">|</span>
          <span class="text-gray-600 font-medium">{{ addr.phoneNumber }}</span>
        </div>
        <p class="text-gray-700 text-sm mb-1">{{ addr.street }}</p>
        <p class="text-gray-500 text-sm">{{ addr.wardDescription }}, {{ addr.city }}</p>
      </div>

      <div class="mt-4 flex gap-4 pt-4 border-t border-gray-50 items-center">
        <button class="text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors flex items-center gap-1"
          (click)="openDialog(addr)">
          <i class="pi pi-file-edit"></i> Cập nhật
        </button>
        <button class="text-sm font-medium text-red-500 hover:text-red-700 transition-colors flex items-center gap-1"
          (click)="deleteAddress(addr.id)">
          <i class="pi pi-trash"></i> Xóa
        </button>

        <button *ngIf="!addr.isDefault"
          class="text-xs font-medium text-gray-500 hover:text-pink-600 ml-auto border border-gray-200 px-3 py-1.5 rounded hover:border-pink-300 hover:bg-pink-50 transition-all"
          (click)="setDefault(addr.id)">
          Thiết lập mặc định
        </button>
      </div>
    </div>
  </div>
</div>

<p-dialog [(visible)]="displayDialog" [header]="isEditMode ? 'Cập nhật địa chỉ' : 'Thêm địa chỉ mới'" [modal]="true"
  [style]="{width: '500px'}" [draggable]="false" [resizable]="false" styleClass="p-fluid">

  <form [formGroup]="addressForm" class="flex flex-col gap-5 mt-2">

    <div class="grid grid-cols-2 gap-4">
      <div class="flex flex-col gap-2">
        <label class="text-sm font-medium text-gray-700">Họ và tên <span class="text-red-500">*</span></label>
        <input pInputText formControlName="receiverName" placeholder="Tên người nhận"
          [ngClass]="{'ng-invalid ng-dirty': addressForm.get('receiverName')?.invalid && addressForm.get('receiverName')?.touched}" />
        <small *ngIf="addressForm.get('receiverName')?.invalid && addressForm.get('receiverName')?.touched"
          class="text-red-500">Bắt buộc nhập.</small>
      </div>
      <div class="flex flex-col gap-2">
        <label class="text-sm font-medium text-gray-700">Số điện thoại <span class="text-red-500">*</span></label>
        <input pInputText formControlName="phoneNumber" placeholder="10 số"
          [ngClass]="{'ng-invalid ng-dirty': addressForm.get('phoneNumber')?.invalid && addressForm.get('phoneNumber')?.touched}" />
        <small *ngIf="addressForm.get('phoneNumber')?.invalid && addressForm.get('phoneNumber')?.touched"
          class="text-red-500">SĐT không hợp lệ.</small>
      </div>
    </div>

    <div class="flex flex-col gap-2">
      <label class="text-sm font-medium text-gray-700">Tỉnh / Thành phố</label>
      <input pInputText value="TP. Hồ Chí Minh" [disabled]="true" class="bg-gray-50 text-gray-500" />
    </div>

    <div class="flex flex-col gap-2">
      <label class="text-sm font-medium text-gray-700">Phường / Xã <span class="text-red-500">*</span></label>

      <p-dropdown [options]="wards" formControlName="ward" optionLabel="name" optionValue="key"
        placeholder="Chọn phường/xã" [filter]="true" filterBy="name" appendTo="body">
      </p-dropdown>

      <small *ngIf="addressForm.get('ward')?.invalid && addressForm.get('ward')?.touched" class="text-red-500">Vui lòng
        chọn phường xã.</small>
    </div>

    <div class="flex flex-col gap-2">
      <label class="text-sm font-medium text-gray-700">Địa chỉ cụ thể <span class="text-red-500">*</span></label>
      <input pInputText formControlName="street" placeholder="Số nhà, tên đường" />
      <small *ngIf="addressForm.get('street')?.invalid && addressForm.get('street')?.touched" class="text-red-500">Bắt
        buộc nhập.</small>
    </div>

    <div class="flex items-center gap-2 mt-2">
      <p-checkbox formControlName="isDefault" [binary]="true" inputId="def"></p-checkbox>
      <label for="def" class="text-sm cursor-pointer select-none text-gray-700">Đặt làm địa chỉ mặc định</label>
    </div>

  </form>

  <ng-template pTemplate="footer">
    <button pButton label="Hủy" (click)="displayDialog=false" class="p-button-text text-gray-500"></button>
    <button pButton label="Lưu địa chỉ" (click)="saveAddress()" class="bg-pink-600 border-pink-600 hover:bg-pink-700"
      [loading]="isSaving"></button>
  </ng-template>
</p-dialog>